(()=>{"use strict";(()=>{function e(e,t,n,o,r=null){let l=new XMLHttpRequest;l.responseType="json",l.addEventListener("load",(function(){200===l.status?n(l.response):o("Произошла ошибка получения: "+l.status+" "+l.text)})),l.open(e,t),l.send(r)}window.backend={getPictures:function(t,n){e("GET","https://21.javascript.pages.academy/kekstagram/data",t,n)},sendForm:function(t,n,o){e("POST","https://21.javascript.pages.academy/kekstagram",n,o,t)}}})(),window.debounce=function(e){let t=null;return function(){let n=arguments;t&&window.clearTimeout(t),t=window.setTimeout((function(){e.apply(null,n)}),500)}},(()=>{let e=document.querySelector("#picture").content.querySelector(".picture"),t=document.querySelector(".pictures"),n=[],o=[];function r(e){let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left="20%",t.style.right="20%",t.style.fontSize="30px",t.style.lineHeight="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}window.sentPhotos=[],window.backend.getPictures((function(e){window.sentPhotos=e,window.galleryFilter.addingPhotos(window.sentPhotos)}),r),window.gallery={pictures:t,renderPhoto:function(t){let r=e.cloneNode(!0);return r.querySelector(".picture__img").src=t.url,r.querySelector(".picture__likes").textContent=t.likes,r.querySelector(".picture__comments").textContent=t.comments.length,n.push(t.description),o.push(t.comments),r},errorHandler:r,getRandomFromArray:function(e){return e[Math.floor(Math.random()*e.length)]},descriptions:n,comments:o}})(),(()=>{let e=document.querySelector(".img-filters"),t=e.querySelector(".img-filters__form"),n=/\d+/;function o(){for(;window.gallery.pictures.children.length>2;)window.gallery.pictures.removeChild(window.gallery.pictures.lastChild)}function r(e,t){let n=document.createDocumentFragment();for(let o=0;o<t;o++)n.appendChild(window.gallery.renderPhoto(e[o]));window.gallery.pictures.appendChild(n)}function l(e){o(),r(e,e.length)}e.classList.remove("img-filters--inactive"),t.addEventListener("click",window.debounce((function(e){switch(e.target.id){case"filter-random":!function(e){let t,n;for(let o=e.length-1;o>0;o--)l=o,t=Math.floor(Math.random()*(l-0+1))+0,n=e[t],e[t]=e[o],e[o]=n;var l;!function(e){o(),r(e,10)}(e)}(window.sentPhotos);break;case"filter-discussed":(t=window.sentPhotos).sort((function(e,t){return t.comments.length-e.comments.length})),l(t);break;default:!function(e){e.sort((function(e,t){return e.url.match(n)-t.url.match(n)})),l(e)}(window.sentPhotos)}var t}))),t.addEventListener("click",(function(e){switch(e.target.id){case"filter-random":t.querySelector("#filter-default").classList.remove("img-filters__button--active"),t.querySelector("#filter-discussed").classList.remove("img-filters__button--active"),e.target.classList.add("img-filters__button--active");break;case"filter-discussed":t.querySelector("#filter-default").classList.remove("img-filters__button--active"),t.querySelector("#filter-random").classList.remove("img-filters__button--active"),e.target.classList.add("img-filters__button--active");break;default:t.querySelector("#filter-random").classList.remove("img-filters__button--active"),t.querySelector("#filter-discussed").classList.remove("img-filters__button--active"),e.target.classList.add("img-filters__button--active")}})),window.galleryFilter={addingPhotos:function(e){r(e,e.length)},numberInString:n}})(),(()=>{let e,t,n,o=document.querySelector(".big-picture"),r=o.querySelector(".big-picture__img").querySelector("img"),l=o.querySelector(".likes-count"),i=o.querySelector(".comments-count"),c=o.querySelector(".social__caption"),s=o.querySelector(".social__comments"),a=o.querySelector(".social__comment"),d=o.querySelector(".social__comment-count"),u=o.querySelector(".comments-loader"),m=o.querySelector(".big-picture__cancel"),f=/\d+(?=\D*$)/;function w(){window.gallery.comments[e].length-t>5?n=t+5:(n=window.gallery.comments[e].length,u.classList.add("hidden"));let o=document.createDocumentFragment();for(let r=t;r<n;r++){let n=a.cloneNode(!0);n.querySelector(".social__text").textContent=window.gallery.comments[e][r].message,n.querySelector(".social__picture").src=window.gallery.comments[e][r].avatar,n.querySelector(".social__picture").alt=window.gallery.comments[e][r].name,o.appendChild(n),t=r+1,d.firstChild.textContent=t+" из "}s.appendChild(o)}function y(e){"Escape"===e.key&&(e.preventDefault(),v())}function v(){o.classList.add("hidden"),document.removeEventListener("keydown",y),document.querySelector("body").classList.remove("modal-open"),s.innerHTML="",u.removeEventListener("click",w)}window.gallery.pictures.addEventListener("click",(function(n){!function(n){n.target&&n.target.matches(".picture__img")&&(r.src=n.target.src,o.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),document.addEventListener("keydown",y),u.classList.remove("hidden"),l.textContent=n.target.nextElementSibling.lastElementChild.textContent,i.textContent=n.target.nextElementSibling.firstElementChild.textContent,c.textContent=window.gallery.descriptions[String(n.target.src.match(f))-1],function(n){let o;t=5,d.firstChild.textContent=t+" из ",e=n.target.src.match(f)-1,window.gallery.comments[e].length<5?(o=window.gallery.comments[e].length,d.firstChild.textContent=window.gallery.comments[e].length+" из ",u.classList.add("hidden")):o=5;let r=document.createDocumentFragment();s.innerHTML="";for(let n=0;n<o;n++){let o=a.cloneNode(!0);o.querySelector(".social__text").textContent=window.gallery.comments[e][n].message,o.querySelector(".social__picture").src=window.gallery.comments[e][n].avatar,o.querySelector(".social__picture").alt=window.gallery.comments[e][n].name,r.appendChild(o),t=n+1}s.appendChild(r)}(n),u.addEventListener("click",w))}(n)})),window.gallery.pictures.addEventListener("keydown",(function(e){"Enter"===e.key&&(r.src=e.target.querySelector("img").src,o.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),document.addEventListener("keydown",y),l.textContent=e.target.querySelector(".picture__likes").textContent,i.textContent=e.target.querySelector(".picture__comments").textContent)})),m.addEventListener("click",(function(){v()})),window.bigPhoto={socialCaption:c}})(),(()=>{const e="100%";let t=document.querySelector("#upload-file"),n=document.querySelector(".img-upload__overlay"),o=n.querySelector("#upload-cancel"),r=n.querySelector(".text__description");function l(e){"Escape"===e.key&&document.activeElement!==window.hashtags.textHashtags&document.activeElement!==r&&(e.preventDefault(),i())}function i(){n.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),document.removeEventListener("keydown",l)}function c(){n.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),o.addEventListener("click",i),document.addEventListener("keydown",l),window.effects.applyEffect("effects__preview--none"),window.scale.imgUploadPreview.removeAttribute("style"),window.effects.effectLevel.style.display="none",window.scale.scaleValue.value=e}let s=document.querySelector(".img-upload__form"),a=document.querySelector("main"),d=document.querySelector("#success").content.querySelector(".success"),u=d.querySelector(".success__overlay"),m=d.querySelector(".success__button"),f=document.querySelector("#error").content.querySelector(".error"),w=f.querySelector(".error__overlay"),y=f.querySelector(".error__button");function v(){window.effects.applyEffect("effects__preview--none"),window.effects.effectLevel.style.display="none",window.hashtags.textHashtags.value="",r.value="",n.classList.add("hidden"),window.scale.scaleValue.value=e}function p(){v(),a.insertAdjacentElement("afterbegin",d)}function g(){v(),a.insertAdjacentElement("afterbegin",f)}function _(){document.removeEventListener("keydown",S),m.removeEventListener("click",h),u.removeEventListener("click",h),y.removeEventListener("click",L),w.removeEventListener("click",L)}function h(){d.remove(),_()}function L(){f.remove(),_()}function S(e){e.preventDefault(),"Escape"===e.key&&"success"===a.firstChild.className?h():L()}s.addEventListener("submit",(function(e){e.preventDefault(),window.backend.sendForm(new FormData(s),p,g),document.addEventListener("keydown",S),m.addEventListener("click",h),u.addEventListener("click",h),y.addEventListener("click",L),w.addEventListener("click",L),document.removeEventListener("keydown",l),t.value=""})),t.addEventListener("change",c),window.form={uploadFile:t,imgUploadOverlay:n,openEditor:c}})(),(()=>{const e="50%",t="75%",n="100%";let o=window.form.imgUploadOverlay.querySelector(".scale__control--smaller"),r=window.form.imgUploadOverlay.querySelector(".scale__control--bigger "),l=window.form.imgUploadOverlay.querySelector(".scale__control--value"),i=window.form.imgUploadOverlay.querySelector(".img-upload__preview");o.addEventListener("click",(function(){!function(){switch(l.value){case n:i.style="transform: scale(0.75)",l.value=t;break;case t:i.style="transform: scale(0.5)",l.value=e;break;default:i.style="transform: scale(0.25)",l.value="25%"}}()})),r.addEventListener("click",(function(){!function(){switch(l.value){case"25%":i.style="transform: scale(0.5)",l.value=e;break;case e:i.style="transform: scale(0.75)",l.value=t;break;default:i.style="transform: scale(1)",l.value=n}}()})),window.scale={imgUploadPreview:i,scaleValue:l}})(),(()=>{const e=100;let t=window.form.imgUploadOverlay.querySelector(".effects__list"),n=window.form.imgUploadOverlay.querySelector(".effect-level"),o=n.querySelector(".effect-level__value"),r=t.querySelectorAll(".effects__preview");function l(e){window.scale.imgUploadPreview.className="img-upload__preview "+e}t.addEventListener("change",(function(t){!function(e){switch(e.target.value){case"chrome":l("effects__preview--chrome"),n.style.display="block";break;case"sepia":l("effects__preview--sepia"),n.style.display="block";break;case"marvin":l("effects__preview--marvin"),n.style.display="block";break;case"phobos":l("effects__preview--phobos"),n.style.display="block";break;case"heat":l("effects__preview--heat"),n.style.display="block";break;default:l("effects__preview--none"),n.style.display="none"}}(t),window.scale.imgUploadPreview.removeAttribute("style"),window.scale.scaleValue.value="100%",c.style.width="100%",i.style.left="100%",o.setAttribute("value",e)}));let i=n.querySelector(".effect-level__pin"),c=n.querySelector(".effect-level__depth");i.addEventListener("mousedown",(function(t){t.preventDefault();let n=t.clientX;function r(t){t.preventDefault();let o=n-t.clientX;n=t.clientX;let r=i.offsetLeft-o;i.style.left=r+"px",c.style.width=r*e/450+"%",r>=450&&(i.style.left="450px",c.style.width="100%"),r<="0"&&(i.style.left="0px",c.style.width="0%")}window.form.imgUploadOverlay.addEventListener("mousemove",r),window.form.imgUploadOverlay.addEventListener("mouseup",(function t(n){n.preventDefault();let l=parseFloat(c.style.width);o.setAttribute("value",l),function(t){switch(window.scale.imgUploadPreview.className){case"img-upload__preview effects__preview--chrome":window.scale.imgUploadPreview.style=`filter: grayscale(${t/e})`;break;case"img-upload__preview effects__preview--sepia":window.scale.imgUploadPreview.style=`filter: sepia(${t/e})`;break;case"img-upload__preview effects__preview--marvin":window.scale.imgUploadPreview.style=`filter: invert(${t}%)`;break;case"img-upload__preview effects__preview--phobos":window.scale.imgUploadPreview.style=`filter: blur(${t/33.3}px)`;break;case"img-upload__preview effects__preview--heat":window.scale.imgUploadPreview.style=`filter: brightness(${t/50+1})`}}(l),window.form.imgUploadOverlay.removeEventListener("mousemove",r),window.form.imgUploadOverlay.removeEventListener("mouseup",t)}))})),window.effects={MAX_VALUE:e,applyEffect:l,effectLevel:n,effectsPreview:r}})(),(()=>{let e=window.form.imgUploadOverlay.querySelector(".text__hashtags"),t=window.form.imgUploadOverlay.querySelector(".img-upload__submit"),n=/^(#[a-zA-Z0-9]{1,19}|$)$/;t.addEventListener("click",(function(){!function(){let t=e.value.toLowerCase().split(" ").filter((function(e){return e}));for(let o=0;o<t.length;o++)n.test(t[o])||e.setCustomValidity("некорректный хэш-тэг"),t[o].indexOf("#",1)>-1&&e.setCustomValidity("хэш-теги разделяются пробелами"),t.length>5&&e.setCustomValidity("нельзя указать больше 5 хэш-тегов"),t.indexOf(t[o],o+1)>-1&&e.setCustomValidity("один и тот же хэш-тег не может быть использован дважды")}()})),e.addEventListener("input",(function(){e.setCustomValidity("")})),window.hashtags={textHashtags:e}})(),(()=>{const e=["gif","jpg","jpeg","png"];let t=window.scale.imgUploadPreview.querySelector("img");window.form.uploadFile.addEventListener("change",(function(){let n=window.form.uploadFile.files[0],o=n.name.toLowerCase();if(e.some((function(e){return o.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){t.src=e.result;for(let t=0;t<window.effects.effectsPreview.length;t++)window.effects.effectsPreview[t].style.backgroundImage=`url("${e.result}")`})),e.readAsDataURL(n)}}))})()})();