(()=>{"use strict";(()=>{function e(e,t,n,o,r=null){let i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(function(){200===i.status?n(i.response):o("Произошла ошибка получения: "+i.status+" "+i.text)})),i.open(e,t),i.send(r)}window.backend={getPictures:function(t,n){e("GET","https://21.javascript.pages.academy/kekstagram/data",t,n)},sendForm:function(t,n,o){e("POST","https://21.javascript.pages.academy/kekstagram",n,o,t)}}})(),window.debounce=function(e){let t=null;return function(){let n=arguments;t&&window.clearTimeout(t),t=window.setTimeout((function(){e.apply(null,n)}),500)}},(()=>{let e=document.querySelector("#picture").content.querySelector(".picture"),t=document.querySelector(".pictures"),n=[],o=[];function r(e){let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left="20%",t.style.right="20%",t.style.fontSize="30px",t.style.lineHeight="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}window.sentPhotos=[],window.backend.getPictures((function(e){window.sentPhotos=e,window.galleryFilter.addingPhotos(window.sentPhotos)}),r),window.gallery={pictures:t,renderPhoto:function(t){let r=e.cloneNode(!0);return r.querySelector(".picture__img").src=t.url,r.querySelector(".picture__likes").textContent=t.likes,r.querySelector(".picture__comments").textContent=t.comments.length,n.push(t.description),o.push(t.comments),r},errorHandler:r,getRandomFromArray:function(e){return e[Math.floor(Math.random()*e.length)]},descriptions:n,comments:o}})(),(()=>{let e=document.querySelector(".img-filters"),t=e.querySelector(".img-filters__form"),n=/\d+/;function o(){for(;window.gallery.pictures.children.length>2;)window.gallery.pictures.removeChild(window.gallery.pictures.lastChild)}function r(e,t){let n=document.createDocumentFragment();for(let o=0;o<t;o++)n.appendChild(window.gallery.renderPhoto(e[o]));window.gallery.pictures.appendChild(n)}function i(e){o(),r(e,e.length)}e.classList.remove("img-filters--inactive"),t.addEventListener("click",window.debounce((function(e){switch(e.target.id){case"filter-random":!function(e){let t=[],n=[];for(let n=0;n<e.length;n++)t[n]=window.gallery.getRandomFromArray(e),t.push(t[n]);n=t.filter((function(e,n){return t.indexOf(e)===n})),function(e){o(),r(e,10)}(n)}(window.sentPhotos);break;case"filter-discussed":(t=window.sentPhotos).sort((function(e,t){return t.comments.length-e.comments.length})),i(t);break;default:!function(e){e.sort((function(e,t){return e.url.match(n)-t.url.match(n)})),i(e)}(window.sentPhotos)}var t}))),t.addEventListener("click",(function(e){switch(e.target.id){case"filter-random":t.querySelector("#filter-default").classList.remove("img-filters__button--active"),t.querySelector("#filter-discussed").classList.remove("img-filters__button--active"),e.target.classList.add("img-filters__button--active");break;case"filter-discussed":t.querySelector("#filter-default").classList.remove("img-filters__button--active"),t.querySelector("#filter-random").classList.remove("img-filters__button--active"),e.target.classList.add("img-filters__button--active");break;default:t.querySelector("#filter-random").classList.remove("img-filters__button--active"),t.querySelector("#filter-discussed").classList.remove("img-filters__button--active"),e.target.classList.add("img-filters__button--active")}})),window.galleryFilter={addingPhotos:function(e){r(e,e.length)},numberInString:n}})(),(()=>{let e,t,n,o=document.querySelector(".big-picture"),r=o.querySelector(".big-picture__img").querySelector("img"),i=o.querySelector(".likes-count"),l=o.querySelector(".comments-count"),c=o.querySelector(".social__caption"),s=o.querySelector(".social__comments"),a=o.querySelector(".social__comment"),d=o.querySelector(".social__comment-count"),u=o.querySelector(".comments-loader"),m=o.querySelector(".big-picture__cancel"),f=/\d+(?=\D*$)/;function w(){window.gallery.comments[e].length-t>5?n=t+5:(n=window.gallery.comments[e].length,u.classList.add("hidden"));let o=document.createDocumentFragment();for(let r=t;r<n;r++){let n=a.cloneNode(!0);n.querySelector(".social__text").textContent=window.gallery.comments[e][r].message,n.querySelector(".social__picture").src=window.gallery.comments[e][r].avatar,n.querySelector(".social__picture").alt=window.gallery.comments[e][r].name,o.appendChild(n),t=r+1,d.firstChild.textContent=t+" из "}s.appendChild(o)}function y(e){"Escape"===e.key&&(e.preventDefault(),v())}function v(){o.classList.add("hidden"),document.removeEventListener("keydown",y),document.querySelector("body").classList.remove("modal-open"),s.innerHTML="",u.removeEventListener("click",w)}window.gallery.pictures.addEventListener("click",(function(n){!function(n){n.target&&n.target.matches(".picture__img")&&(r.src=n.target.src,o.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),document.addEventListener("keydown",y),u.classList.remove("hidden"),i.textContent=n.target.nextElementSibling.lastElementChild.textContent,l.textContent=n.target.nextElementSibling.firstElementChild.textContent,c.textContent=window.gallery.descriptions[String(n.target.src.match(f))-1],function(n){let o;t=5,d.firstChild.textContent=t+" из ",e=n.target.src.match(f)-1,window.gallery.comments[e].length<5?(o=window.gallery.comments[e].length,d.firstChild.textContent=window.gallery.comments[e].length+" из ",u.classList.add("hidden")):o=5;let r=document.createDocumentFragment();s.innerHTML="";for(let n=0;n<o;n++){let o=a.cloneNode(!0);o.querySelector(".social__text").textContent=window.gallery.comments[e][n].message,o.querySelector(".social__picture").src=window.gallery.comments[e][n].avatar,o.querySelector(".social__picture").alt=window.gallery.comments[e][n].name,r.appendChild(o),t=n+1}s.appendChild(r)}(n),u.addEventListener("click",w))}(n)})),window.gallery.pictures.addEventListener("keydown",(function(e){"Enter"===e.key&&(r.src=e.target.querySelector("img").src,o.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),document.addEventListener("keydown",y),i.textContent=e.target.querySelector(".picture__likes").textContent,l.textContent=e.target.querySelector(".picture__comments").textContent)})),m.addEventListener("click",(function(){v()})),window.bigPhoto={socialCaption:c}})(),(()=>{let e=document.querySelector("#upload-file"),t=document.querySelector(".img-upload__overlay"),n=t.querySelector("#upload-cancel"),o=t.querySelector(".text__description");function r(e){"Escape"===e.key&&document.activeElement!==window.hashtags.textHashtags&document.activeElement!==o&&(e.preventDefault(),i())}function i(){t.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),document.removeEventListener("keydown",r)}function l(){t.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),n.addEventListener("click",i),document.addEventListener("keydown",r),window.effects.applyEffect("effects__preview--none"),window.scale.imgUploadPreview.removeAttribute("style"),window.effects.effectLevel.style.display="none"}let c=document.querySelector(".img-upload__form"),s=document.querySelector("main"),a=document.querySelector("#success").content.querySelector(".success"),d=a.querySelector(".success__overlay"),u=a.querySelector(".success__button"),m=document.querySelector("#error").content.querySelector(".error"),f=m.querySelector(".error__overlay"),w=m.querySelector(".error__button");function y(){window.effects.applyEffect("effects__preview--none"),window.effects.effectLevel.style.display="none",window.hashtags.textHashtags.value="",o.value="",t.classList.add("hidden"),window.scale.scaleValue.value=window.effects.MAX_VALUE_PERCENT+"%"}function v(){y(),s.insertAdjacentElement("afterbegin",a)}function p(){y(),s.insertAdjacentElement("afterbegin",m)}function g(){document.removeEventListener("keydown",L),u.removeEventListener("click",_),d.removeEventListener("click",_),w.removeEventListener("click",h),f.removeEventListener("click",h)}function _(){a.remove(),g()}function h(){m.remove(),g()}function L(e){e.preventDefault(),"Escape"===e.key&&"success"===s.firstChild.className?_():h()}c.addEventListener("submit",(function(t){t.preventDefault(),window.backend.sendForm(new FormData(c),v,p),document.addEventListener("keydown",L),u.addEventListener("click",_),d.addEventListener("click",_),w.addEventListener("click",h),f.addEventListener("click",h),document.removeEventListener("keydown",r),e.value=""})),e.addEventListener("change",l),window.form={uploadFile:e,imgUploadOverlay:t,openEditor:l}})(),(()=>{const e="50%",t="75%",n="100%";let o=window.form.imgUploadOverlay.querySelector(".scale__control--smaller"),r=window.form.imgUploadOverlay.querySelector(".scale__control--bigger "),i=window.form.imgUploadOverlay.querySelector(".scale__control--value"),l=window.form.imgUploadOverlay.querySelector(".img-upload__preview");o.addEventListener("click",(function(){!function(){switch(i.value){case n:l.style="transform: scale(0.75)",i.value=t;break;case t:l.style="transform: scale(0.5)",i.value=e;break;default:l.style="transform: scale(0.25)",i.value="25%"}}()})),r.addEventListener("click",(function(){!function(){switch(i.value){case"25%":l.style="transform: scale(0.5)",i.value=e;break;case e:l.style="transform: scale(0.75)",i.value=t;break;default:l.style="transform: scale(1)",i.value=n}}()})),window.scale={imgUploadPreview:l,scaleValue:i}})(),(()=>{const e=100;let t=window.form.imgUploadOverlay.querySelector(".effects__list"),n=window.form.imgUploadOverlay.querySelector(".effect-level"),o=n.querySelector(".effect-level__value"),r=t.querySelectorAll(".effects__preview");function i(e){window.scale.imgUploadPreview.className="img-upload__preview "+e}t.addEventListener("change",(function(t){!function(e){switch(e.target.value){case"chrome":i("effects__preview--chrome"),n.style.display="block";break;case"sepia":i("effects__preview--sepia"),n.style.display="block";break;case"marvin":i("effects__preview--marvin"),n.style.display="block";break;case"phobos":i("effects__preview--phobos"),n.style.display="block";break;case"heat":i("effects__preview--heat"),n.style.display="block";break;default:i("effects__preview--none"),n.style.display="none"}}(t),window.scale.imgUploadPreview.removeAttribute("style"),window.scale.scaleValue.value="100%",c.style.width="100%",l.style.left="100%",o.setAttribute("value",e)}));let l=n.querySelector(".effect-level__pin"),c=n.querySelector(".effect-level__depth");l.addEventListener("mousedown",(function(t){t.preventDefault();let n=t.clientX;function r(t){t.preventDefault();let o=n-t.clientX;n=t.clientX;let r=l.offsetLeft-o;l.style.left=r+"px",c.style.width=r*e/450+"%",r>=450&&(l.style.left="450px",c.style.width="100%"),r<="0"&&(l.style.left="0px",c.style.width="0%")}window.form.imgUploadOverlay.addEventListener("mousemove",r),window.form.imgUploadOverlay.addEventListener("mouseup",(function t(n){n.preventDefault();let i=parseFloat(c.style.width);o.setAttribute("value",i),function(t){switch(window.scale.imgUploadPreview.className){case"img-upload__preview effects__preview--chrome":window.scale.imgUploadPreview.style=`filter: grayscale(${t/e})`;break;case"img-upload__preview effects__preview--sepia":window.scale.imgUploadPreview.style=`filter: sepia(${t/e})`;break;case"img-upload__preview effects__preview--marvin":window.scale.imgUploadPreview.style=`filter: invert(${t}%)`;break;case"img-upload__preview effects__preview--phobos":window.scale.imgUploadPreview.style=`filter: blur(${t/33.3}px)`;break;case"img-upload__preview effects__preview--heat":window.scale.imgUploadPreview.style=`filter: brightness(${t/50+1})`}}(i),window.form.imgUploadOverlay.removeEventListener("mousemove",r),window.form.imgUploadOverlay.removeEventListener("mouseup",t)}))})),window.effects={applyEffect:i,effectLevel:n,effectsPreview:r}})(),(()=>{let e=window.form.imgUploadOverlay.querySelector(".text__hashtags"),t=window.form.imgUploadOverlay.querySelector(".img-upload__submit"),n=/^(#[a-zA-Z0-9]{1,19}|$)$/;t.addEventListener("click",(function(){!function(){let t=e.value.toLowerCase().split(" ");for(let o=0;o<t.length;o++)n.test(t[o])||e.setCustomValidity("некорректный хэш-тэг"),t[o].indexOf("#",1)>-1&&e.setCustomValidity("хэш-теги разделяются пробелами"),t.length>5&&e.setCustomValidity("нельзя указать больше 5 хэш-тегов"),t.indexOf(t[o],o+1)>-1&&e.setCustomValidity("один и тот же хэш-тег не может быть использован дважды")}()})),e.addEventListener("input",(function(){e.setCustomValidity("")})),window.hashtags={textHashtags:e}})(),(()=>{const e=["gif","jpg","jpeg","png"];let t=window.scale.imgUploadPreview.querySelector("img");window.form.uploadFile.addEventListener("change",(function(){let n=window.form.uploadFile.files[0],o=n.name.toLowerCase();if(e.some((function(e){return o.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){t.src=e.result;for(let t=0;t<window.effects.effectsPreview.length;t++)window.effects.effectsPreview[t].style.backgroundImage=`url("${e.result}")`})),e.readAsDataURL(n)}}))})()})();