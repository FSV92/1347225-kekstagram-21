(()=>{"use strict";window.backend={getPictures:function(e,t){let n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(function(){200===n.status?e(n.response):t("Произошла ошибка получения: "+n.status+" "+n.text)})),n.open("GET","https://21.javascript.pages.academy/kekstagram/data"),n.send()},sendForm:function(e,t,n){let o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){200===o.status?t():n()})),o.open("POST","https://21.javascript.pages.academy/kekstagram"),o.send(e)}},window.debounce=function(e){let t=null;return function(){let n=arguments;t&&window.clearTimeout(t),t=window.setTimeout((function(){e.apply(null,n)}),1500)}},(()=>{let e=document.querySelector("#picture").content.querySelector(".picture"),t=document.querySelector(".pictures"),n=[],o=[];window.sentPhotos=[];let r=function(e){let t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left="20%",t.style.right="20%",t.style.fontSize="30px",t.style.lineHeight="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)};window.backend.getPictures((function(e){window.sentPhotos=e,window.galleryFilter.addingPhotos(window.sentPhotos)}),r),window.gallery={pictures:t,renderPhoto:function(t){let r=e.cloneNode(!0);return r.querySelector(".picture__img").src=t.url,r.querySelector(".picture__likes").textContent=t.likes,r.querySelector(".picture__comments").textContent=t.comments.length,n.push(t.description),o.push(t.comments),r},errorHandler:r,getRandomFromArray:function(e){return e[Math.floor(Math.random()*e.length)]},descriptions:n,comments:o}})(),(()=>{let e=document.querySelector(".img-filters"),t=e.querySelector(".img-filters__form"),n=/\d+/;e.classList.remove("img-filters--inactive");let o=function(e){let t=document.createDocumentFragment();for(let n=0;n<e.length;n++)t.appendChild(window.gallery.renderPhoto(e[n]));for(;window.gallery.pictures.children.length>2;)window.gallery.pictures.removeChild(window.gallery.pictures.lastChild);window.gallery.pictures.appendChild(t)};t.addEventListener("click",window.debounce((function(e){switch(e.target.id){case"filter-random":!function(e){let t=[],n=[];for(let n=0;n<e.length;n++)t[n]=window.gallery.getRandomFromArray(e),t.push(t[n]);n=t.filter((function(e,n){return t.indexOf(e)===n})),function(e){let t=document.createDocumentFragment();for(let n=0;n<10;n++)t.appendChild(window.gallery.renderPhoto(e[n]));for(;window.gallery.pictures.children.length>2;)window.gallery.pictures.removeChild(window.gallery.pictures.lastChild);window.gallery.pictures.appendChild(t)}(n)}(window.sentPhotos);break;case"filter-discussed":(t=window.sentPhotos).sort((function(e,t){return t.comments.length-e.comments.length})),o(t);break;default:!function(e){e.sort((function(e,t){return e.url.match(n)-t.url.match(n)})),o(e)}(window.sentPhotos)}var t}))),t.addEventListener("click",(function(e){switch(e.target.id){case"filter-random":t.querySelector("#filter-default").classList.remove("img-filters__button--active"),t.querySelector("#filter-discussed").classList.remove("img-filters__button--active"),e.target.classList.add("img-filters__button--active");break;case"filter-discussed":t.querySelector("#filter-default").classList.remove("img-filters__button--active"),t.querySelector("#filter-random").classList.remove("img-filters__button--active"),e.target.classList.add("img-filters__button--active");break;default:t.querySelector("#filter-random").classList.remove("img-filters__button--active"),t.querySelector("#filter-discussed").classList.remove("img-filters__button--active"),e.target.classList.add("img-filters__button--active")}})),window.galleryFilter={addingPhotos:function(e){let t=document.createDocumentFragment();for(let n=0;n<e.length;n++)t.appendChild(window.gallery.renderPhoto(e[n]));window.gallery.pictures.appendChild(t)},numberInString:n}})(),(()=>{let e,t,n,o=document.querySelector(".big-picture"),r=o.querySelector(".big-picture__img").querySelector("img"),l=o.querySelector(".likes-count"),i=o.querySelector(".comments-count"),c=o.querySelector(".social__caption"),s=o.querySelector(".social__comments"),a=o.querySelector(".social__comment"),d=o.querySelector(".social__comment-count"),u=o.querySelector(".comments-loader"),m=o.querySelector(".big-picture__cancel"),f=/\d+(?=\D*$)/,w=function(){window.gallery.comments[e].length-t>5?n=t+5:(n=window.gallery.comments[e].length,u.classList.add("hidden"));let o=document.createDocumentFragment();for(let r=t;r<n;r++){let n=a.cloneNode(!0);n.querySelector(".social__text").textContent=window.gallery.comments[e][r].message,n.querySelector(".social__picture").src=window.gallery.comments[e][r].avatar,n.querySelector(".social__picture").alt=window.gallery.comments[e][r].name,o.appendChild(n),t=r+1,d.firstChild.textContent=t+" из "}s.appendChild(o)},y=function(e){"Escape"===e.key&&(e.preventDefault(),p())},p=function(){o.classList.add("hidden"),document.removeEventListener("keydown",y),document.querySelector("body").classList.remove("modal-open"),s.innerHTML="",u.removeEventListener("click",w)};window.gallery.pictures.addEventListener("click",(function(n){!function(n){n.target&&n.target.matches(".picture__img")&&(r.src=n.target.src,o.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),document.addEventListener("keydown",y),u.classList.remove("hidden"),l.textContent=n.target.nextElementSibling.lastElementChild.textContent,i.textContent=n.target.nextElementSibling.firstElementChild.textContent,c.textContent=window.gallery.descriptions[String(n.target.src.match(f))-1],function(n){let o;t=5,d.firstChild.textContent=t+" из ",e=n.target.src.match(f)-1,window.gallery.comments[e].length<5?(o=window.gallery.comments[e].length,d.firstChild.textContent=window.gallery.comments[e].length+" из ",u.classList.add("hidden")):o=5;let r=document.createDocumentFragment();s.innerHTML="";for(let n=0;n<o;n++){let o=a.cloneNode(!0);o.querySelector(".social__text").textContent=window.gallery.comments[e][n].message,o.querySelector(".social__picture").src=window.gallery.comments[e][n].avatar,o.querySelector(".social__picture").alt=window.gallery.comments[e][n].name,r.appendChild(o),t=n+1}s.appendChild(r)}(n),u.addEventListener("click",w))}(n)})),window.gallery.pictures.addEventListener("keydown",(function(e){"Enter"===e.key&&(r.src=e.target.querySelector("img").src,o.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),document.addEventListener("keydown",y),l.textContent=e.target.querySelector(".picture__likes").textContent,i.textContent=e.target.querySelector(".picture__comments").textContent)})),m.addEventListener("click",(function(){p()})),window.bigPhoto={socialCaption:c}})(),(()=>{let e=document.querySelector("#upload-file"),t=document.querySelector(".img-upload__overlay"),n=t.querySelector("#upload-cancel"),o=t.querySelector(".text__description"),r=function(e){"Escape"===e.key&&document.activeElement!==window.hashtags.textHashtags&document.activeElement!==o&&(e.preventDefault(),l())},l=function(){t.classList.add("hidden"),document.querySelector("body").classList.remove("modal-open"),document.removeEventListener("keydown",r)},i=function(){t.classList.remove("hidden"),document.querySelector("body").classList.add("modal-open"),n.addEventListener("click",l),document.addEventListener("keydown",r),window.effects.applyEffect("effects__preview--none"),window.scale.imgUploadPreview.removeAttribute("style"),window.effects.effectLevel.style.display="none"},c=document.querySelector(".img-upload__form"),s=document.querySelector("main"),a=document.querySelector("#success").content.querySelector(".success"),d=a.querySelector(".success__overlay"),u=a.querySelector(".success__button"),m=document.querySelector("#error").content.querySelector(".error"),f=m.querySelector(".error__overlay"),w=m.querySelector(".error__button"),y=function(){window.effects.applyEffect("effects__preview--none"),window.effects.effectLevel.style.display="none",window.hashtags.textHashtags.value="",o.value="",t.classList.add("hidden"),window.scale.scaleValue.value="100%"},p=function(){y(),s.insertAdjacentElement("afterbegin",a)},v=function(){y(),s.insertAdjacentElement("afterbegin",m)},g=function(){document.removeEventListener("keydown",L),u.removeEventListener("click",_),d.removeEventListener("click",_),w.removeEventListener("click",h),f.removeEventListener("click",h)},_=function(){a.remove(),g()},h=function(){m.remove(),g()},L=function(e){e.preventDefault(),"Escape"===e.key&&"success"===s.firstChild.className?_():h()};c.addEventListener("submit",(function(t){t.preventDefault(),window.backend.sendForm(new FormData(c),p,v),document.addEventListener("keydown",L),u.addEventListener("click",_),d.addEventListener("click",_),w.addEventListener("click",h),f.addEventListener("click",h),document.removeEventListener("keydown",r),e.value=""})),e.addEventListener("change",i),window.form={uploadFile:e,imgUploadOverlay:t,openEditor:i}})(),(()=>{let e=window.form.imgUploadOverlay.querySelector(".scale__control--smaller"),t=window.form.imgUploadOverlay.querySelector(".scale__control--bigger "),n=window.form.imgUploadOverlay.querySelector(".scale__control--value"),o=window.form.imgUploadOverlay.querySelector(".img-upload__preview");e.addEventListener("click",(function(){!function(){switch(n.value){case"100%":o.style="transform: scale(0.75)",n.value="75%";break;case"75%":o.style="transform: scale(0.5)",n.value="50%";break;default:o.style="transform: scale(0.25)",n.value="25%"}}()})),t.addEventListener("click",(function(){!function(){switch(n.value){case"25%":o.style="transform: scale(0.5)",n.value="50%";break;case"50%":o.style="transform: scale(0.75)",n.value="75%";break;default:o.style="transform: scale(1)",n.value="100%"}}()})),window.scale={imgUploadPreview:o,scaleValue:n}})(),(()=>{let e=window.form.imgUploadOverlay.querySelector(".effects__list"),t=window.form.imgUploadOverlay.querySelector(".effect-level"),n=t.querySelector(".effect-level__value"),o=e.querySelectorAll(".effects__preview"),r=function(e){window.scale.imgUploadPreview.className="img-upload__preview "+e};e.addEventListener("change",(function(e){!function(e){switch(e.target.value){case"chrome":r("effects__preview--chrome"),t.style.display="block";break;case"sepia":r("effects__preview--sepia"),t.style.display="block";break;case"marvin":r("effects__preview--marvin"),t.style.display="block";break;case"phobos":r("effects__preview--phobos"),t.style.display="block";break;case"heat":r("effects__preview--heat"),t.style.display="block";break;default:r("effects__preview--none"),t.style.display="none"}}(e),window.scale.imgUploadPreview.removeAttribute("style"),window.scale.scaleValue.value="100%",i.style.width="100%",l.style.left="100%",n.setAttribute("value",100)}));let l=t.querySelector(".effect-level__pin"),i=t.querySelector(".effect-level__depth");l.addEventListener("mousedown",(function(e){e.preventDefault();let t=e.clientX,o=function(e){e.preventDefault();let n=t-e.clientX;t=e.clientX;let o=l.offsetLeft-n;l.style.left=o+"px",i.style.width=100*o/450+"%",o>="450"&&(l.style.left="450px",i.style.width="100%"),o<="0"&&(l.style.left="0px",i.style.width="0%")},r=function(e){e.preventDefault();let t=parseFloat(i.style.width);n.setAttribute("value",t),function(e){switch(window.scale.imgUploadPreview.className){case"img-upload__preview effects__preview--chrome":window.scale.imgUploadPreview.style=`filter: grayscale(${e/100})`;break;case"img-upload__preview effects__preview--sepia":window.scale.imgUploadPreview.style=`filter: sepia(${e/100})`;break;case"img-upload__preview effects__preview--marvin":window.scale.imgUploadPreview.style=`filter: invert(${e}%)`;break;case"img-upload__preview effects__preview--phobos":window.scale.imgUploadPreview.style=`filter: blur(${e/33.3}px)`;break;case"img-upload__preview effects__preview--heat":window.scale.imgUploadPreview.style=`filter: brightness(${e/50+1})`}}(t),window.form.imgUploadOverlay.removeEventListener("mousemove",o),window.form.imgUploadOverlay.removeEventListener("mouseup",r)};window.form.imgUploadOverlay.addEventListener("mousemove",o),window.form.imgUploadOverlay.addEventListener("mouseup",r)})),window.effects={applyEffect:r,effectLevel:t,effectsPreview:o}})(),(()=>{let e=window.form.imgUploadOverlay.querySelector(".text__hashtags"),t=window.form.imgUploadOverlay.querySelector(".img-upload__submit"),n=/^#[a-zA-Z0-9]{1,19}$/;t.addEventListener("click",(function(){!function(){let t=e.value.toLowerCase().split(" ");for(let o=0;o<t.length;o++)n.test(t[o])||e.setCustomValidity("некорректный хэш-тэг"),t[o].indexOf("#",1)>-1&&e.setCustomValidity("хэш-теги разделяются пробелами"),t.length>5&&e.setCustomValidity("нельзя указать больше 5 хэш-тегов"),t.indexOf(t[o],o+1)>-1&&e.setCustomValidity("один и тот же хэш-тег не может быть использован дважды")}()})),e.addEventListener("input",(function(){e.setCustomValidity("")})),window.hashtags={textHashtags:e}})(),(()=>{const e=["gif","jpg","jpeg","png"];let t=window.scale.imgUploadPreview.querySelector("img");window.form.uploadFile.addEventListener("change",(function(){let n=window.form.uploadFile.files[0],o=n.name.toLowerCase();if(e.some((function(e){return o.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){t.src=e.result;for(let t=0;t<window.effects.effectsPreview.length;t++)window.effects.effectsPreview[t].style.backgroundImage=`url("${e.result}")`})),e.readAsDataURL(n)}}))})()})();